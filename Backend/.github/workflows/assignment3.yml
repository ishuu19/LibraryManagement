name: Test report for Assignment 3

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:6
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'" --health-interval=10s --health-timeout=5s --health-retries=10
    env:
      COPILOT_ALLOW_ALL: "true"
      NODE_ENV: development
      MONGODB_URI: mongodb://127.0.0.1:27017/comp3047
      COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}
      COPILOT_MCP: ${{ secrets.COPILOT_MCP }}
      COMP3047_FALL2025_ASS3PROMPT: ${{ secrets.COMP3047_FALL2025_ASS3PROMPT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v2

      - name: Setup uv/uvx (Python runner) â€” use context7
        uses: astral-sh/setup-uv@v4
        with:
          python-version: '3.12'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Verify uvx installed
        run: |
          uv --version
          uvx --version

      - name: Setup Copilot CLI
        run: |
          npm install -g @github/copilot
          copilot --version

      - name: Install deps
        run: |
          npm install
          npm init playwright@latest
          npx playwright install --with-deps
          npm install --save-dev eslint@latest @eslint/js@latest eslint-config-xo
          echo "import config from 'eslint-config-xo';
          import {defineConfig} from 'eslint/config';

          export default defineConfig([
                  config,
          ]);" > eslint.config.mjs
          npm install selenium-webdriver --save-dev
          npm install mongodb --save
          npm install puppeteer --save-dev
          go install github.com/isaacphi/mcp-language-server@latest

      - name: Setup git author information
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "<>"

      - name: Setup folders for report
        run: |
          mkdir -p report/screenshots
          mkdir -p report/logs
          mkdir -p report/docs

      - name: Download frontend zip artifact
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_VUE="${REPO_NAME/express/vue}"
          curl -L -o dist.zip "https://ug-cs-hkbu.github.io/$REPO_VUE/dist.zip"
          unzip dist.zip -d public/
          cp -a public/dist/* public/
        env:
          REPO_OWNER: ${{ github.repository }}

      - name: Wait for MongoDB (Context7 inspired health pattern using ping)
        run: |
          for i in {1..30}; do
            if mongosh "$MONGODB_URI" --quiet --eval 'db.runCommand({ping:1}).ok' 2>/dev/null | grep -q 1; then
              echo "MongoDB is up"; break; fi; sleep 2; done
          node -e "require('mongodb').MongoClient.connect(process.env.MONGODB_URI).then(()=>{console.log('Driver connection OK');process.exit(0)}).catch(e=>{console.error(e);process.exit(1)})"
        shell: bash

      - name: Generate e2e test scripts via Copilot CLI using JavaScript and Playwright
        continue-on-error: true
        run: |
          copilot --add-dir / --additional-mcp-config "$COPILOT_MCP" --log-level debug --log-dir report/logs --allow-all-tools --model claude-haiku-4.5 -p "$COMP3047_FALL2025_ASS3PROMPT"
          cp *.md report/docs/
        env:
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}

      - uses: docker://pandoc/core:3.5
        continue-on-error: true
        with:
          args: >-  # allows you to break string into multiple lines
            --standalone
            --output=report/index.html
            report/README.md

      - name: Upload logs and report as artifact
        id: deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: >-
            report/

  deploy:
    permissions:
      id-token: write
      pages: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

